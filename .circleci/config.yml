# Use the latest 2.1 version of CircleCI pipeline process engine.
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
  # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
  build:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
            # ... steps for building/testing app ...
      - setup_remote_docker:
          version: 20.10.14
          docker_layer_caching: true
      - run: 
          name: Start all services declared in docker-compose.yml
          command: docker-compose up -d --build

      # - run:
      #     name: Start docker-compose and verify service(s)
      #     command: |
      #       # Setting the Docker Compose project name to "ft_trancendence" means
      #       # the names of our services' containers would be prefixed with "ft_trancendence".
      #       docker-compose --project ft_trancendence up -d --build

      #       # In this example, we have a "contacts" service, and
      #       # we are trying to check, via `dockerize`, if the service is ready.
      #       docker container run --network container:ft_trancendence_contacts_1 \
      #         docker.io/jwilder/dockerize \
      #         -wait http://localhost:8082/\
      #         -wait-retry-interval 2s \
      #         -timeout 20s
      
      - run:
          name: Wait for db
          command: dockerize -wait tcp://localhost:5432 -timeout 1m

      - run:
          name: Build-app
          command: "./CiTests.sh"
      - run:
          name: "Say hello"
          command: "echo Hello, World!"